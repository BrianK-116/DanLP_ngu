<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>UTEvuive_search</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .box { box-shadow: 0 6px 24px rgba(0,0,0,.08); }
    .chip{ background:#e5e7eb; padding:.25rem .5rem; border-radius:999px; }
    .g { display:grid; gap:.75rem; }
    .g-cols { grid-template-columns: repeat(4, minmax(0,1fr)); }
    @media (max-width: 1024px){ .g-cols { grid-template-columns: repeat(3, 1fr);} }
    @media (max-width: 768px){ .g-cols { grid-template-columns: repeat(2, 1fr);} }
    .clamp-1 {
      display: -webkit-box;
      -webkit-line-clamp: 1;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: normal;}
    .card:focus { outline: 2px solid #2563eb; outline-offset: 2px; } /* vi·ªÅn xanh khi focus */
    .obj-cover{ object-fit: cover; }                                  /* alias cho g·ªçn l·ªõp */
    .jc-between{ justify-content: space-between; }                    /* alias cho g·ªçn l·ªõp */
  </style>
</head>
<body class="bg-slate-50 text-slate-800">

  <!-- Header -->
  <header class="bg-white border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <a href="{{ url_for('home') }}" class="flex items-center gap-2 font-semibold">
        <span class="inline-block w-7 h-7 rounded bg-blue-600"></span>
        <span>Visione-style</span>
      </a>
      <nav class="ml-auto hidden md:flex gap-2 text-sm">
        <span class="px-3 py-1 rounded hover:bg-slate-100 cursor-default">Docs</span>
        <span class="px-3 py-1 rounded hover:bg-slate-100 cursor-default">Dataset</span>
        <span class="px-3 py-1 rounded hover:bg-slate-100 cursor-default">About</span>
      </nav>
    </div>
  </header>

  <!-- Toolbar -->
  <section class="max-w-6xl mx-auto px-4 pt-5">
    <div class="flex flex-col md:flex-row md:items-center gap-3">

      <!-- Tabs -->
      <div class="bg-white border rounded p-1 box flex gap-1">
        <span class="px-3 py-1 rounded border bg-blue-50 text-blue-700 text-sm">KIS</span>
        <span class="px-3 py-1 rounded hover:bg-slate-100 text-sm">AVS</span>
        <span class="px-3 py-1 rounded hover:bg-slate-100 text-sm">Q&A</span>
      </div>

      <!-- Dataset -->
      <select class="bg-white border rounded px-2 py-2">
        <option>AIC25 (Keyframes)</option>
        <option>LSC</option>
        <option>V3C1</option>
      </select>

      <!-- Search form -->
      <form action="{{ url_for('textsearch') }}" method="get" class="relative flex-1">
        <input
          name="textquery"
          type="text"
          value="{{ ui.textquery if ui else '' }}"
          placeholder="Describe scene / text... (vi/en)"
          class="w-full bg-white border rounded px-3 py-3 pr-28 box"
          autocomplete="off">
        <div class="absolute right-2 top-1/2 -translate-y-1/2 flex gap-2">
          <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-4 py-2 rounded">Search</button>
        </div>
        <input type="hidden" name="search_type" value="{{ ui.search_type if ui else 'hybrid' }}">
        <input type="hidden" name="topk"        value="{{ ui.topk if ui else 100 }}">
        <input type="hidden" name="wvis"        value="{{ ui.wvis if ui else 0.6 }}">
        <input type="hidden" name="wtxt"        value="{{ ui.wtxt if ui else 0.4 }}">
        <input type="hidden" name="constraints" value="{{ ui.constraints if ui else '' }}">
        <input type="hidden" name="index"       value="0">
      </form>
    </div>

    <!-- Chips -->
    <div class="mt-2 flex items-center gap-2 text-xs">
      <span class="text-slate-500">Examples:</span>
      <button type="button" class="chip ex">bi·ªÉn ho√†ng h√¥n c√≥ thuy·ªÅn</button>
      <button type="button" class="chip ex">man holding red umbrella</button>
      <button type="button" class="chip ex">text: cafe open 24h</button>
    </div>
  </section>

  <!-- Main -->
  <main class="max-w-6xl mx-auto px-4 pt-4 pb-10 grid lg:grid-cols-12 gap-3">

    <!-- Filters -->
    <aside class="lg:col-span-3 bg-white border rounded p-3 box">
      <div class="text-sm font-semibold mb-2">Filters</div>
      <div class="mb-3">
        <div class="text-sm mb-1">Search type</div>
        <div class="grid grid-cols-3 gap-2">
          <label class="border rounded p-2 flex gap-2 items-center">
            <input type="radio" name="stype" value="hybrid" {{ 'checked' if (ui and ui.search_type=='hybrid') or (not ui) else '' }}>
            <span class="text-sm">Hybrid</span>
          </label>
          <label class="border rounded p-2 flex gap-2 items-center">
            <input type="radio" name="stype" value="visual" {{ 'checked' if (ui and ui.search_type=='visual') else '' }}>
            <span class="text-sm">Visual</span>
          </label>
          <label class="border rounded p-2 flex gap-2 items-center">
            <input type="radio" name="stype" value="ocr" {{ 'checked' if (ui and ui.search_type=='ocr') else '' }}>
            <span class="text-sm">Text</span>
          </label>
        </div>
      </div>
      <div class="mb-3">
        <div class="text-sm mb-1">Top-K</div>
        <input id="topk" type="range" min="10" max="500" step="10" value="{{ ui.topk if ui else 100 }}" class="w-full">
        <div class="flex justify-between text-xs text-slate-500">
          <span>10</span><span id="topkLabel">{{ ui.topk if ui else 100 }}</span><span>500</span>
        </div>
      </div>
      <div class="mb-3">
        <div class="text-sm mb-1">RRF (w<sub>vis</sub> / w<sub>txt</sub>)</div>
        <div class="flex gap-2 items-center">
          <input id="wvis" type="number" step="0.1" class="border rounded px-2 py-1 w-20" value="{{ ui.wvis if ui else 0.6 }}">
          <span>/</span>
          <input id="wtxt" type="number" step="0.1" class="border rounded px-2 py-1 w-20" value="{{ ui.wtxt if ui else 0.4 }}">
        </div>
      </div>
      <div class="mb-2">
        <div class="text-sm mb-1">Constraints</div>
        <input id="constraints" type="text" class="border rounded px-2 py-2 w-full" placeholder="car, red; text:pizza" value="{{ ui.constraints if ui else '' }}">
      </div>
    </aside>

    <!-- Results -->
    <section class="lg:col-span-6">
      <div class="flex items-center justify-between text-sm text-slate-500 mb-2">
        <div><b class="text-slate-700">{{ total or 0 }}</b> results in {{ elapsed or 0 }} ms</div>
        <div class="flex items-center gap-2">
          <span>Sort</span>
          <select class="border rounded px-2 py-1">
            <option>Score (desc)</option>
            <option>ID (asc)</option>
          </select>
        </div>
      </div>

      <!-- L∆∞·ªõi ·∫£nh -->
    <div class="g g-cols">
      {% for r in results or [] %}
      <!-- th·∫ª ·∫£nh: th√™m data-* ƒë·ªÉ JS l·∫•y l·∫°i th√¥ng tin khi click -->
      <div
        class="card bg-white border rounded overflow-hidden box cursor-pointer"
        tabindex="0"                                        
        data-id="{{ r['id'] }}"                             
        data-path="{{ r['path'] }}"                         
        data-score="{{ r.get('score', 0.0) }}"              
        onclick="onPick(this)"                              
        onkeydown="if(event.key==='Enter'||event.key===' '){onPick(this)}"  
      >
        <!-- ·∫£nh thu nh·ªè -->
        <img
          src="{{ url_for('get_img', fpath=r['path']) }}"    
          alt="id {{ r['id'] }}"
          class="w-full h-40 obj-cover"
          loading="lazy"
        >
        <!-- th√¥ng tin nh·ªè d∆∞·ªõi ·∫£nh -->
        <div class="p-2 text-xs text-slate-600">
          <div class="flex jc-between">
            <span>ID: <b class="text-slate-800">{{ r['id'] }}</b></span>
            <span>Score: {{ '%.4f'|format(r.get('score', 0.0)) }}</span>
          </div>
          {% if r.get('ocr') %}
          <div class="mt-1 line-clamp-1">üÖæÔ∏è {{ r['ocr'] }}</div>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>


      <div class="mt-3 flex items-center justify-center gap-2">
        {% if page and page > 0 %}
          <a href="{{ url_for('home',
                              index=page-1,
                              textquery=(ui.textquery if ui else ''),
                              search_type=(ui.search_type if ui else 'hybrid'),
                              topk=(ui.topk if ui else 100),
                              wvis=(ui.wvis if ui else 0.6),
                              wtxt=(ui.wtxt if ui else 0.4),
                              constraints=(ui.constraints if ui else '')) }}"
            class="border rounded px-3 py-1 hover:bg-slate-100">Prev</a>
        {% endif %}
        <span class="text-sm text-slate-600">Page {{ (page or 0) + 1 }}</span>
        {% if has_more %}
          <a href="{{ url_for('home',
                              index=(page or 0)+1,
                              textquery=(ui.textquery if ui else ''),
                              search_type=(ui.search_type if ui else 'hybrid'),
                              topk=(ui.topk if ui else 100),
                              wvis=(ui.wvis if ui else 0.6),
                              wtxt=(ui.wtxt if ui else 0.4),
                              constraints=(ui.constraints if ui else '')) }}"
            class="border rounded px-3 py-1 hover:bg-slate-100">Next</a>
        {% endif %}
      </div>
    </section>

    <!-- Preview -->
    <!-- C·ªôt ph·∫£i: Preview (c√≥ ·∫£nh, ch·ªó tr·ªëng cho video, v√† n√∫t Find similar) -->
<aside class="lg:col-span-3 bg-white border rounded p-3 box">
  <!-- khung media -->
  <div class="w-full aspect-video bg-slate-100 rounded flex items-center justify-center overflow-hidden">
    <!-- ·∫¢NH PREVIEW (hi·ªÉn th·ªã ngay) -->
    <img id="pvImg" src="" alt="preview" class="max-w-full max-h-full hidden">  <!-- b·∫Øt ƒë·∫ßu ·∫©n, hi·ªán khi ch·ªçn -->
    <!-- VIDEO PREVIEW (ƒë·ªÉ d√†nh t∆∞∆°ng lai) -->
    <video id="pvVid" controls class="w-full h-full hidden"></video>            <!-- sau n√†y set src ƒë·ªÉ ph√°t -->
    <!-- placeholder khi ch∆∞a ch·ªçn -->
    <span id="pvPh" class="text-slate-400 text-sm">Click m·ªôt ·∫£nh ƒë·ªÉ xem chi ti·∫øt‚Ä¶</span>
  </div>

  <!-- th√¥ng tin + h√†nh ƒë·ªông -->
  <div class="mt-3 text-sm">
    <div class="font-semibold mb-2">Details</div>
    <div class="grid grid-cols-3 gap-2 text-xs">
      <div class="bg-slate-50 rounded p-2">ID<br><b id="pvId">‚Äî</b></div>
      <div class="bg-slate-50 rounded p-2">Score<br><b id="pvScore">‚Äî</b></div>
      <div class="bg-slate-50 rounded p-2">Timecode<br><b id="pvTime">‚Äî</b></div> <!-- ƒë·ªÉ d√†nh n·∫øu c√≥ -->
    </div>

    <!-- n√∫t h√†nh ƒë·ªông -->
    <div class="mt-3 flex gap-2">
      <!-- Find similar: d·∫´n t·ªõi /imgsearch?imgid=<id> k√®m tham s·ªë UI -->
      <a id="btnSimilar"
         href="#"
         class="px-3 py-2 rounded bg-blue-600 text-white text-xs hover:bg-blue-700 disabled:opacity-50"
         aria-disabled="true">Find similar</a>

      <!-- n√∫t chuy·ªÉn Media (·∫£nh <-> video) ƒë·ªÉ sau n√†y d√πng -->
      <button id="btnToggle"
              type="button"
              class="px-3 py-2 rounded border text-xs hover:bg-slate-50"
              disabled>Show video</button>
    </div>
  </div>
</aside>


  <script defer>
    const form = document.querySelector('form[action*="textsearch"]');
    const sync = () => {
      if (!form) return;
      const st = document.querySelector('input[name="stype"]:checked');
      form.querySelector('input[name="search_type"]').value = st ? st.value : 'hybrid';
      form.querySelector('input[name="topk"]').value        = document.getElementById('topk').value;
      form.querySelector('input[name="wvis"]').value        = document.getElementById('wvis').value || 0.6;
      form.querySelector('input[name="wtxt"]').value        = document.getElementById('wtxt').value || 0.4;
      form.querySelector('input[name="constraints"]').value = document.getElementById('constraints').value || '';
      form.querySelector('input[name="index"]').value = 0;
    };
    document.querySelectorAll('input[name="stype"]').forEach(r => r.addEventListener('change', sync));
    ['topk','wvis','wtxt','constraints'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('input', () => {
        if (id === 'topk') document.getElementById('topkLabel').textContent = el.value;
        sync();
      });
    });
    document.querySelectorAll('.ex').forEach(b => b.addEventListener('click', () => {
      const q = document.querySelector('input[name="textquery"]');
      if (!q) return;
      q.value = b.textContent.trim();
      q.focus();
    }));
    document.addEventListener('DOMContentLoaded', sync);
  </script>
  <script defer>
    const form = document.querySelector('form[action*="textsearch"]');
    const sync = () => {
      if (!form) return;
      const st = document.querySelector('input[name="stype"]:checked');
      form.querySelector('input[name="search_type"]').value = st ? st.value : 'hybrid';
      form.querySelector('input[name="topk"]').value        = document.getElementById('topk').value;
      form.querySelector('input[name="wvis"]').value        = document.getElementById('wvis').value || 0.6;
      form.querySelector('input[name="wtxt"]').value        = document.getElementById('wtxt').value || 0.4;
      form.querySelector('input[name="constraints"]').value = document.getElementById('constraints').value || '';
      form.querySelector('input[name="index"]').value = 0;
    };
    document.querySelectorAll('input[name="stype"]').forEach(r => r.addEventListener('change', sync));
    ['topk','wvis','wtxt','constraints'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('input', () => {
        if (id === 'topk') document.getElementById('topkLabel').textContent = el.value;
        sync();
      });
    });
    document.querySelectorAll('.ex').forEach(b => b.addEventListener('click', () => {
      const q = document.querySelector('input[name="textquery"]');
      if (!q) return; q.value = b.textContent.trim(); q.focus();
    }));
    document.addEventListener('DOMContentLoaded', sync);
  </script>

  <!-- ‚úÖ n·∫°p visual.js *tr∆∞·ªõc khi ƒë√≥ng body* ƒë·ªÉ c√≥ h√†m onPick -->
  <script src="{{ url_for('static', filename='js/visual.js') }}" defer></script>
</body>
</html>
